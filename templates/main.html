<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    
    <title>Natural language processing and data visualization challenge</title>

    <!-- Bootstrap -->
    <link href="{{ url_for('static', filename='css/bootstrap.min.css') }}" rel="stylesheet">
    <link href="https://cdn.datatables.net/1.10.10/css/jquery.dataTables.min.css">

    <!-- D3 and first graph -->
    <script src="http://d3js.org/d3.v3.min.js"></script>
    <script src="https://rawgit.com/newrelic-forks/d3-plugins-sankey/master/sankey.js"></script>
    <script src="https://rawgit.com/misoproject/d3.chart/master/d3.chart.min.js"></script>
    <script src="https://rawgit.com/q-m/d3.chart.sankey/master/d3.chart.sankey.min.js"></script>
    <script src="{{ url_for('static', filename='js/wordcloud.js') }}"></script>

    <style>
      

      .node rect {
        fill-opacity: .9;
        shape-rendering: crispEdges;
      }
      .node text {
        text-shadow: 0 1px 0 #fff;
      }
      .link {
        fill: none;
        stroke: #000;
        stroke-opacity: .2;
      }
    
    </style>


  </head>
  <body>
    <div class="container">
      {# {% with messages = get_flashed_messages() %}
        {% if messages %}
          <ul class=flashes>
          {% for message in messages %}
            <li>{{ message }}</li>
          {% endfor %}
          </ul>
        {% endif %}
      {% endwith %} #}
        <div class="row">
            <div class="col-md-12">
                <h1 class="text-center">Links between Urban Development and the other United Nations Sustainable Development Goals</h1>
            </div>
        </div>

        <div class="row">
          <div class="col-md-12">
            <div id="#tabs">

            <!-- Nav tabs -->
            <ul class="nav nav-tabs" role="tablist">
              <li role="presentation" class="active"><a href="#home" aria-controls="home" role="tab" data-toggle="tab">Links distribution between SDG11 and the others regarding to reports</a></li>
              <li role="presentation"><a href="#profile" aria-controls="profile" role="tab" data-toggle="tab">Links distribution between SDG11 and the others regarding to 4 types of relationships</a></li>
            </ul>
            <br/>
            <!-- Tab panes -->
            <div class="tab-content">
              <div role="tabpanel" class="tab-pane fade in active" id="home">
                <div class="row">
                  <div class="col-md-12">
                    <div id="chart2"></div>
                  </div>
                </div>
              </div>
              <div role="tabpanel" class="tab-pane fade" id="profile">
                <div class="row">
                  <div class="col-md-12">
                    <div id="chart1"></div>
                  </div>
                </div>
              </div>
            </div>

          </div>
          </div>
        </div>
       
        <!-- <div class="row">
          <div class="col-md-6">
            <div class="row">
              <div class="col-md-12">
                <h3>Header 1</h3>
              </div>
            </div>
        
            <div class="row">
              <div class="col-md-12">
                
              </div>
            </div>
                      
          </div>
          <div class="col-md-6">
            <div class="row">
              <div class="col-md-12">
                <h3>Header 2</h3>
              </div>
            </div>
            
            <div class="row">
              <div class="col-md-12">
                <div id="chart2"></div>
              </div>
            </div>
          </div>
        </div> -->

        <div class="row">
          <div class="col-md-6">
            <div class="row">
              <div class="col-md-12">
                <h3>Percentage of relationships for each link  between  Urban Development and the others</h3>
              </div>
            </div>
            
            <div class="row">
              <div class="col-md-12">
                <img class="img-responsive img-rounded" src="{{ url_for('static', filename='media/Accuracy2.jpg') }}" alt="bar chart">
              </div>
            </div>
          </div>

          <div class="col-md-6">
            <div class="row">
              <div class="col-md-12">
                <h3>Percent  of  links for each related Category and  Urban Development</h3>
              </div>
            </div>
            
            <div class="row">
              <div class="col-md-12">
                <img class="img-responsive img-rounded" src="{{ url_for('static', filename='media/Pie.jpg') }}" alt="bar chart">
              </div>
            </div>
          </div>
        </div>

        <div class="row">
          <div class="col-md-12"><h3>Wordcloud with keywords for linkages between SDGs</h3></div>
          <div class="col-md-6">
            <div class="row">
              <div class="col-md-12">
                <h4>Sustainable cities and communities</h4>
              </div>
            </div>
            
            <div class="row">
              <div class="col-md-12">
                <div id="cloud1"></div>
              </div>
            </div>
          </div>

          <div class="col-md-6">
            <div class="row">
              <div class="col-md-12">
                <h4>Filter (categories)</h4>
              </div>
            </div>
            <div class="row">
              <div class="col-md-12">
                  <form class="form-inline" action="javascript:void(null);" method="POST" name='chose2' id="form2" onsubmit="call2()">
                  <!-- <form class="form-inline" action="/" method="POST" name='chose2' id="form2"> -->
                     <div class="alert alert-danger" role="alert" id="error2">
                      </div>
                      {{form2.hidden_tag()}}
                      <div class="row">
                            <div class="col-md-4"><div class="form-group input-group" >{{ form2.cloud_category(class="form-control input-sm") }}</div></div>
                            <div class="col-md-1"><div class="form-group input-group" ><button  name="submit2" class="btn btn-default btn-sm">Submit</button></div></div>
                        </div>
                  </form>
              </div>
            </div>
            
            <div class="row">
              <div class="col-md-12">
                <div id="cloud2"></div>
              </div>
            </div>
          </div>
        </div>

        <div class="row">
          <div class="col-md-12">
             <div class="row">
              <div class="col-md-12">
                <h3>Header 6</h3>
              </div>
            </div>
            <div class="row">
                <div class="col-md-12">
                    <h5>Little instruction</h5>
                    <p>Ut in tincidunt metus. Morbi pulvinar facilisis justo, in blandit lectus cursus vitae. Etiam aliquet orci non ipsum bibendum fermentum. Fusce a turpis eget odio auctor tempus. Vestibulum luctus, libero vel.</p>
                </div>
            </div>

            <div class="row">
                <div class="col-md-12">
                  <form class="form-inline" action="javascript:void(null);" method="POST" name='chose' id="form1" onsubmit="call1()">
                    <!-- <form class="form-inline" action="/" method="POST" name='chose1'> -->

                        <div class="alert alert-danger" role="alert" id="error1">
                        </div>

                      {{form1.hidden_tag()}}
                      <div class="row">
                            <div class="col-md-4"><div class="form-group input-group" >{{ form1.relation(class="form-control input-sm") }}</div></div>
                            <div class="col-md-4"><div class="form-group input-group" >{{ form1.category(class="form-control input-sm") }}</div></div>
                            <div class="col-md-3"><div class="form-group input-group" >{{ form1.messages_number(class="form-control input-sm", placeholder="Limit", type="number", min=1) }}</div></div>
                            <div class="col-md-1"><div class="form-group input-group" ><button type="submit" name="submit1" class="btn btn-default btn-sm">Submit</button></div></div>
                        </div>
                  </form>
                  <br>
                </div>
            </div>

            <div class="row">
                <div class="col-md-12">
                  <ul id="response1">
                  </ul>
                </div>
            </div>

          </div>
        </div>
    </div>

    <!-- jQuery (necessary for Bootstrap's JavaScript plugins) -->
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.3/jquery.min.js"></script>
    
    <!-- Latest compiled and minified JavaScript -->
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/js/bootstrap.min.js" integrity="sha384-0mSbJDEHialfmuBBQP6A4Qrprq5OVfW37PRR3j5ELqxss1yVqOtnepnHVP9aJ7xS" crossorigin="anonymous"></script>
    <!--<script src="https://cdn.datatables.net/1.10.10/js/jquery.dataTables.min.js"></script>-->

    <!-- First cloud -->
    <script>
    var data = {{cloud | tojson|safe }};
    var fill = d3.scale.category20();
    var layout = d3.layout.cloud()
        .size([600, 600])
        .words(data[0].map(function(d) {
          return {text: d[0], size: d[1], test: "haha"};
        }))
        .padding(5)
        .rotate(0)
        .font("Impact")
        .fontSize(function(d) { return d.size; })
        .on("end", draw);

    layout.start();

    function draw(words) {
      d3.select("#cloud1").append("div")
              .classed("svg-container", true)
              .append("svg")
              .attr("preserveAspectRatio", "xMinYMin meet")
              .attr("viewBox", "0 0 600 600")
              .classed("svg-content-responsive", true)
        .append("g")
          .attr("transform", "translate(" + layout.size()[0] / 2 + "," + layout.size()[1] / 2 + ")")
        .selectAll("text")
          .data(words)
        .enter().append("text")
          .style("font-size", function(d) { return d.size + "px"; })
          .style("font-family", "Impact")
          .style("fill", function(d, i) { return fill(i); })
          .attr("text-anchor", "middle")
          .attr("transform", function(d) {
            return "translate(" + [d.x, d.y] + ")rotate(" + d.rotate + ")";
          })
          .text(function(d) { return d.text; });
    }
    </script>

    <!-- Second cloud -->
    <script>
    var fill2 = d3.scale.category20();

    var layout2 = d3.layout.cloud()
        .size([600, 600])
        .words(data[1].map(function(d) {
          return {text: d[0], size: 10+d[1]*Math.random(), test: "haha"};
        }))
        .padding(5)
        .rotate(0)
        .font("Impact")
        .fontSize(function(d) { return d.size; })
        .on("end", draw2);

    layout2.start();

    function draw2(words) {
      d3.select("#cloud2").append("div")
              .classed("svg-container", true)
              .append("svg")
              .attr("preserveAspectRatio", "xMinYMin meet")
              .attr("viewBox", "0 0 600 600")
              .classed("svg-content-responsive", true)
        .append("g")
          .attr("transform", "translate(" + layout2.size()[0] / 2 + "," + layout2.size()[1] / 2 + ")")
        .selectAll("text")
          .data(words)
        .enter().append("text")
          .style("font-size", function(d) { return d.size + "px"; })
          .style("font-family", "Impact")
          .style("fill", function(d, i) { return fill(i); })
          .attr("text-anchor", "middle")
          .attr("transform", function(d) {
            return "translate(" + [d.x, d.y] + ")rotate(" + d.rotate + ")";
          })
          .text(function(d) { return d.text; });
    }
    </script>

    <!-- First graph -->
    <script>
      var margin = {top: 1, right: 1, bottom: 6, left: 1},
          width = 1300- margin.left - margin.right,
          height = 960 - margin.top - margin.bottom;
       
      var formatNumber = d3.format(",.0f"),
          format = function(d) { return formatNumber(d) ; },
          color = d3.scale.category20();
       
      var svg1 = d3.select("#chart1").append("div")
              .classed("svg-container", true)
              .append("svg")
              .attr("preserveAspectRatio", "xMinYMin meet")
              .attr("viewBox", "0 0 1300 960")
              .classed("svg-content-responsive", true)
        .append("g")
          .attr("transform", "translate(" + margin.left + "," + margin.top + ")");
       
      var sankey1 = d3.sankey()
          .nodeWidth(10)
          .nodePadding(5)
          .size([width, height]);
       
      var path1 = sankey1.link();
       
      d3.json("{{ url_for('static', filename='data/file.json') }}", function(energy) {
       
        sankey1
            .nodes(energy.nodes)
            .links(energy.links)
            .layout(32);
       
        var link = svg1.append("g").selectAll(".link")
            .data(energy.links)
          .enter().append("path")
            .attr("class", "link")
            .attr("d", path1)
            .attr("id", function(d,i){
              d.id = i;
              return "link_f-"+i;
            })
            .on('mouseover', function() { 
                d3.select("#chart1").selectAll(".link").style("stroke-opacity", 0.1); 
                d3.select("#chart1").select("#"+this.id).style("stroke-opacity", 0.6) })
            .on('mouseout', function() { 
                d3.select("#chart1").selectAll(".link").style("stroke-opacity", 0.2);
                d3.select("#chart1").select("#"+this.id).style("stroke-opacity", 0.2) })
            .style("stroke-width", function(d) { return Math.max(1, d.dy); })
            .sort(function(a, b) { return b.dy - a.dy; })
            .style("stroke", function(d) { return color(d.color); });
       
        link.append("title")
            .text(function(d) { return d.source.name + " → " + d.target.name + "\n" + format(d.value); });
       
        var node1 = svg1.append("g").selectAll(".node")
            .data(energy.nodes)
          .enter().append("g")
            .attr("class", "node")
            .attr("transform", function(d) { return "translate(" + d.x + "," + d.y + ")"; })
            // .on("click", highlight_node_links)
            .on('mouseover', highlight_node_links1)
            .on('mouseout', highlight_node_links1)
          .call(d3.behavior.drag()
            .origin(function(d) { return d; })
            .on("dragstart", function() { this.parentNode.appendChild(this); })
            .on("drag", dragmove));
       
        node1.append("rect")
            .attr("height", function(d) { return d.dy; })
            .attr("width", sankey1.nodeWidth())
            .style("fill", function(d) { return d.color = color(d.name.replace(/ .*/, "")); })
            .style("stroke", function(d) { return d3.rgb(d.color).darker(2); })
          .append("title")
            .text(function(d) { return d.name + "\n" + format(d.value); });
       
        node1.append("text")
            .attr("x", -6)
            .attr("y", function(d) { return d.dy / 2; })
            .attr("dy", ".35em")
            .attr("text-anchor", "end")
            .attr("transform", null)
            .attr("font-size", 10)
            .text(function(d) { return d.name; })
          .filter(function(d) { return d.x < width / 2; })
            .attr("x", 6 + sankey1.nodeWidth())
            .attr("text-anchor", "start");
       
        function dragmove(d) {
          d3.select(this).attr("transform", "translate(" + d.x + "," + (d.y = Math.max(0, Math.min(height - d.dy, d3.event.y))) + ")");
          sankey1.relayout();
          link.attr("d", path1);
        }

        function highlight_node_links1(node1,i){

          var remainingNodes1=[],
              nextNodes1=[];

          var stroke_opacity = 0;
          if( d3.select(this).attr("data-clicked") == "1" ){
            d3.select(this).attr("data-clicked","0");
            stroke_opacity = 0.2;
          }else{
            d3.select(this).attr("data-clicked","1");
            stroke_opacity = 0.6;
          }

          var traverse = [{
                            linkType : "sourceLinks",
                            nodeType : "target"
                          },{
                            linkType : "targetLinks",
                            nodeType : "source"
                          }];

          traverse.forEach(function(step){
            node1[step.linkType].forEach(function(link) {
              remainingNodes1.push(link[step.nodeType]);
              highlight_link1(link.id, stroke_opacity);
            });

            while (remainingNodes1.length) {
              nextNodes1 = [];
              remainingNodes1.forEach(function(node1) {
                node1[step.linkType].forEach(function(link) {
                  nextNodes1.push(link[step.nodeType]);
                  highlight_link1(link.id, stroke_opacity);
                });
              });
              remainingNodes1 = nextNodes1;
            }
          });
        }

        function highlight_link1(id,opacity){
            d3.select("#link_f-"+id).style("stroke-opacity", opacity);
        }

      });

    </script>

    <!-- Second graph -->
    <script>

     var margin = {top: 1, right: 1, bottom: 6, left: 1},
          width = 1300 - margin.left - margin.right,
          height = 760 - margin.top - margin.bottom;
       
      var formatNumber = d3.format(",.0f"),
          format = function(d) { return formatNumber(d) ; },
          color = d3.scale.category20();
       
      var svg2 = d3.select("#chart2").append("div")
              .classed("svg-container", true)
              .append("svg")
              .attr("preserveAspectRatio", "xMinYMin meet")
              .attr("viewBox", "0 0 1300 760")
              .classed("svg-content-responsive", true)
        .append("g")
          .attr("transform", "translate(" + margin.left + "," + margin.top + ")");
       
      var sankey = d3.sankey()
          .nodeWidth(15)
          .nodePadding(10)
          .size([width, height]);
       
      var path = sankey.link();
       
      d3.json("{{ url_for('static', filename='data/file2.json') }}", function(energy) {
       
        sankey
            .nodes(energy.nodes)
            .links(energy.links)
            .layout(32);
       
        var link = svg2.append("g").selectAll(".link")
            .data(energy.links)
          .enter().append("path")
            .attr("class", "link")
            .attr("d", path)
            .attr("id", function(d,i){
              d.id = i;
              return "link-"+i;
            })
            .on('mouseover', function() { 
                d3.select("#chart2").selectAll(".link").style("stroke-opacity", 0.1); 
                d3.select("#chart2").select("#"+this.id).style("stroke-opacity", 0.6) })
            .on('mouseout', function() { 
                d3.select("#chart2").selectAll(".link").style("stroke-opacity", 0.2);
                d3.select("#chart2").select("#"+this.id).style("stroke-opacity", 0.2) })
            .style("stroke-width", function(d) { return Math.max(1, d.dy); })
            .sort(function(a, b) { return b.dy - a.dy; })
            .style("stroke", function(d) { return color(d.color); });
       
        link.append("title")
            .text(function(d) { return d.source.name + " → " + d.target.name + "\n" + format(d.value); });
       
        var node = svg2.append("g").selectAll(".node")
            .data(energy.nodes)
          .enter().append("g")
            .attr("class", "node")
            .attr("transform", function(d) { return "translate(" + d.x + "," + d.y + ")"; })
            // .on("click", highlight_node_links)
            .on('mouseover', highlight_node_links)
            .on('mouseout', highlight_node_links)
          .call(d3.behavior.drag()
            .origin(function(d) { return d; })
            .on("dragstart", function() { this.parentNode.appendChild(this); })
            .on("drag", dragmove));
       
        node.append("rect")
            .attr("height", function(d) { return d.dy; })
            .attr("width", sankey.nodeWidth())
            .style("fill", function(d) { return d.color = color(d.name.replace(/ .*/, "")); })
            .style("stroke", function(d) { return d3.rgb(d.color).darker(2); })
          .append("title")
            .text(function(d) { return d.name + "\n" + format(d.value); });
       
        node.append("text")
            .attr("x", -6)
            .attr("y", function(d) { return d.dy / 2; })
            .attr("dy", ".35em")
            .attr("text-anchor", "end")
            .attr("transform", null)
            .attr("font-size", 16)
            .text(function(d) { return d.name; })
          .filter(function(d) { return d.x < width / 2; })
            .attr("x", 6 + sankey.nodeWidth())
            .attr("text-anchor", "start");
       
        function dragmove(d) {
          d3.select(this).attr("transform", "translate(" + d.x + "," + (d.y = Math.max(0, Math.min(height - d.dy, d3.event.y))) + ")");
          sankey.relayout();
          link.attr("d", path);
        }

        function highlight_node_links(node,i){

          var remainingNodes=[],
              nextNodes=[];

          var stroke_opacity = 0;
          if( d3.select(this).attr("data-clicked") == "1" ){
            d3.select(this).attr("data-clicked","0");
            stroke_opacity = 0.2;
          }else{
            d3.select(this).attr("data-clicked","1");
            stroke_opacity = 0.6;
          }

          var traverse = [{
                            linkType : "sourceLinks",
                            nodeType : "target"
                          },{
                            linkType : "targetLinks",
                            nodeType : "source"
                          }];

          traverse.forEach(function(step){
            node[step.linkType].forEach(function(link) {
              remainingNodes.push(link[step.nodeType]);
              highlight_link(link.id, stroke_opacity);
            });

            while (remainingNodes.length) {
              nextNodes = [];
              remainingNodes.forEach(function(node) {
                node[step.linkType].forEach(function(link) {
                  nextNodes.push(link[step.nodeType]);
                  highlight_link(link.id, stroke_opacity);
                });
              });
              remainingNodes = nextNodes;
            }
          });
        }

        function highlight_link(id,opacity){
            d3.select("#link-"+id).style("stroke-opacity", opacity);
        }

      });
    </script>
    
    <!-- Tab -->
    <script>
      $('#tabs a').click(function (e) {
        e.preventDefault()
        $(this).tab('show')
      })
    </script>
    <!-- Ajax -->
    <script>
    // $('#results').hide();
    var err = $('#error1'),
        err2 = $('#error2');
    err.hide();
    err2.hide();
    function call1() {
      var msg1   = $('#form1').serialize();
        $.ajax({
          type: 'POST',
          url: '/one',
          data: msg1,
          success: function(data) {
            console.log(data);
            var ul = $('#response1');
            ul.empty();
            err.hide();
            err.empty();
            if (data['data']) {
              for(var key in data['data']) {
                ul.append('<li>'+data['data'][key]+'</li>');
              }
            } else {
              err.show();
              for(var error in data['error']) {
                err.append('<li>'+data['error'][error]+'</li>');
              }
            }
            
          },
          error:  function(xhr, str){
                alert('Error: ' + xhr.responseCode);
            }
        });
     
    }
    
    function call2() {
      var msg2   = $('#form2').serialize();
        $.ajax({
          type: 'POST',
          url: '/two',
          data: msg2,
          success: function(data) {
            console.log(data);
            err2.hide();
            err2.empty();

            if (data['data']) {
              
            } else {
              err2.show();
              for(var error in data['error']) {
                err2.append('<li>'+data['error'][error]+'</li>');
              }
            }

          },
          error:  function(xhr, str){
                alert('Error: ' + xhr.responseCode);
            }
        });
    }

    </script>

 </body>
</html>