<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    
    <title>Natural language processing and data visualization challenge</title>

    <!-- Bootstrap -->
    <link href="{{ url_for('static', filename='css/bootstrap.min.css') }}" rel="stylesheet">
    <link href="https://cdn.datatables.net/1.10.10/css/jquery.dataTables.min.css">

    <!-- D3 and first graph -->
    <script src="http://d3js.org/d3.v3.min.js"></script>
    <script src="https://rawgit.com/newrelic-forks/d3-plugins-sankey/master/sankey.js"></script>
    <script src="https://rawgit.com/misoproject/d3.chart/master/d3.chart.min.js"></script>
    <script src="https://rawgit.com/q-m/d3.chart.sankey/master/d3.chart.sankey.min.js"></script>

    <style>
      
      #chart {
        
        height: 400px;
        clear: both;
      }
      .node rect {
        fill-opacity: .9;
        shape-rendering: crispEdges;
      }
      .node text {
        text-shadow: 0 1px 0 #fff;
      }
      .link {
        fill: none;
        stroke: #000;
        stroke-opacity: .2;
      }
    
    </style>


  </head>
  <body>
    <div class="container-fluid">
      {# {% with messages = get_flashed_messages() %}
        {% if messages %}
          <ul class=flashes>
          {% for message in messages %}
            <li>{{ message }}</li>
          {% endfor %}
          </ul>
        {% endif %}
      {% endwith %} #}
        <div class="row">
            <div class="col-md-12">
                <h1>Header global</h1>
            </div>
        </div>

        <div class="row">
            <div class="col-md-6">
                <h3>Header 1</h3>
            </div>
            <div class="col-md-6">
                <h3>Header 2</h3>
            </div>
        </div>

        <div class="row">
          <div class="col-md-6">
            <div id="chart"></div>          
          </div>
          <div class="col-md-6">
            <div id="chart2"></div>
          </div>
        </div>

        <div class="row">
            <div class="col-md-6">
                <h3>Header 3</h3>
            </div>
            <div class="col-md-6">
                <h3>Header 4</h3>
            </div>
        </div>

        <div class="row">
          <div class="col-md-6">
            <div id="chart3"></div>
          </div>
          <div class="col-md-6">
            <div class="row">
                <div class="col-md-12">
                    <h5>Little instruction</h5>
                    <p>Ut in tincidunt metus. Morbi pulvinar facilisis justo, in blandit lectus cursus vitae. Etiam aliquet orci non ipsum bibendum fermentum. Fusce a turpis eget odio auctor tempus. Vestibulum luctus, libero vel.</p>
                </div>
            </div>

            <div class="row">
                <div class="col-md-12">
                    <form class="form-inline" action="/" method="POST" name='chose'>
                      {% if form.errors %}
                        <div class="alert alert-danger" role="alert">
                          {% for field_name, field_errors in form.errors|dictsort if field_errors %}
                              {% for error in field_errors %}
                                  <li>{{ form[field_name].label }}: {{ error }}</li>
                              {% endfor %}
                          {% endfor %}
                        </div>
                      {% endif %}
                      {{form.hidden_tag()}}
                      <div class="form-group" >{{ form.relation(class="form-control input-sm") }}</div>
                      <div class="form-group" >{{ form.category(class="form-control input-sm") }}</div>
                      <div class="form-group" >{{ form.messages_number(class="form-control input-sm", placeholder="Number of messages", type="number", min=1) }}</div>
                      <button type="submit" class="btn btn-default btn-sm">Submit</button>
                  </form>
                  <br>
                </div>
            </div>

            <div class="row">
                <div class="col-md-12">
                    <table class="table table-bordered table-hover" id="table_id" width="100%">
                        <thead>
                            <th>Head 1</th>
                            <th>Head 2</th>
                            <th>Head 3</th>
                        </thead>
        
                        <tbody> 
                            <tr>
                                <td>Clumn 1</td>
                                <td>Clumn 2</td>
                                <td>Clumn 3</td>
                            </tr>
                            <tr>
                                <td>Clumn 1</td>
                                <td>Clumn 2</td>
                                <td>Clumn 3</td>
                            </tr>
                            <tr>
                                <td>Clumn 1</td>
                                <td>Clumn 2</td>
                                <td>Clumn 3</td>
                            </tr>
                            <tr>
                                <td>Clumn 1</td>
                                <td>Clumn 2</td>
                                <td>Clumn 3</td>
                            </tr>
                            <tr>
                                <td>Clumn 1</td>
                                <td>Clumn 2</td>
                                <td>Clumn 3</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
          </div>
        </div>
    </div>

    <!-- jQuery (necessary for Bootstrap's JavaScript plugins) -->
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.3/jquery.min.js"></script>
    <script src="https://cdn.datatables.net/1.10.10/js/jquery.dataTables.min.js"></script>
    <!-- First graph -->
    <script>

    d3.json("{{ url_for('static', filename='data/for_graph1.json') }}", function(error, json) {

        function render () {
          var chart =  d3.select("#chart").append("svg").chart('Sankey.Path');
          chart
            .nodePadding(20)
            .colorLinks(d3.scale.category20c());
          chart.draw(json);
          chart.on('link:mouseover', function(link) {
            console.log('Clicked on ' + link);
            });
        }

        render();

        d3.select(window).on("resize", function() {
          d3.select("svg").remove();
          render();
          })

      });

    </script>

    <!-- Second graph -->
    <script>

     var margin = {top: 1, right: 1, bottom: 6, left: 1},
          width = 700 - margin.left - margin.right,
          height = 400 - margin.top - margin.bottom;
       
      var formatNumber = d3.format(",.0f"),
          format = function(d) { return formatNumber(d) + " TWh"; },
          color = d3.scale.category20();
       
      var svg2 = d3.select("#chart2").append("div")
              .classed("svg-container", true)
              .append("svg")
              .attr("preserveAspectRatio", "xMinYMin meet")
              .attr("viewBox", "0 0 700 400")
              .classed("svg-content-responsive", true)
        .append("g")
          .attr("transform", "translate(" + margin.left + "," + margin.top + ")");
       
      var sankey = d3.sankey()
          .nodeWidth(15)
          .nodePadding(20)
          .size([width, height]);
       
      var path = sankey.link();
       
      d3.json("{{ url_for('static', filename='data/for_graph2.json') }}", function(energy) {
       
        sankey
            .nodes(energy.nodes)
            .links(energy.links)
            .layout(32);
       
        var link = svg2.append("g").selectAll(".link")
            .data(energy.links)
          .enter().append("path")
            .attr("class", "link")
            .attr("d", path)
            .attr("id", function(d,i){
              d.id = i;
              return "link-"+i;
            })
            .style("stroke-width", function(d) { return Math.max(1, d.dy); })
            .sort(function(a, b) { return b.dy - a.dy; })
            .style("stroke", function(d) { return color(d.color); });
       
        link.append("title")
            .text(function(d) { return d.source.name + " â†’ " + d.target.name + "\n" + format(d.value); });
       
        var node = svg2.append("g").selectAll(".node")
            .data(energy.nodes)
          .enter().append("g")
            .attr("class", "node")
            .attr("transform", function(d) { return "translate(" + d.x + "," + d.y + ")"; })
            .on("click",highlight_node_links)
          .call(d3.behavior.drag()
            .origin(function(d) { return d; })
            .on("dragstart", function() { this.parentNode.appendChild(this); })
            .on("drag", dragmove));
       
        node.append("rect")
            .attr("height", function(d) { return d.dy; })
            .attr("width", sankey.nodeWidth())
            .style("fill", function(d) { return d.color = color(d.name.replace(/ .*/, "")); })
            .style("stroke", function(d) { return d3.rgb(d.color).darker(2); })
          .append("title")
            .text(function(d) { return d.name + "\n" + format(d.value); });
       
        node.append("text")
            .attr("x", -6)
            .attr("y", function(d) { return d.dy / 2; })
            .attr("dy", ".35em")
            .attr("text-anchor", "end")
            .attr("transform", null)
            .text(function(d) { return d.name; })
          .filter(function(d) { return d.x < width / 2; })
            .attr("x", 6 + sankey.nodeWidth())
            .attr("text-anchor", "start");
       
        function dragmove(d) {
          d3.select(this).attr("transform", "translate(" + d.x + "," + (d.y = Math.max(0, Math.min(height - d.dy, d3.event.y))) + ")");
          sankey.relayout();
          link.attr("d", path);
        }

        function highlight_node_links(node,i){

          var remainingNodes=[],
              nextNodes=[];

          var stroke_opacity = 0;
          if( d3.select(this).attr("data-clicked") == "1" ){
            d3.select(this).attr("data-clicked","0");
            stroke_opacity = 0.2;
          }else{
            d3.select(this).attr("data-clicked","1");
            stroke_opacity = 0.5;
          }

          var traverse = [{
                            linkType : "sourceLinks",
                            nodeType : "target"
                          },{
                            linkType : "targetLinks",
                            nodeType : "source"
                          }];

          traverse.forEach(function(step){
            node[step.linkType].forEach(function(link) {
              remainingNodes.push(link[step.nodeType]);
              highlight_link(link.id, stroke_opacity);
            });

            while (remainingNodes.length) {
              nextNodes = [];
              remainingNodes.forEach(function(node) {
                node[step.linkType].forEach(function(link) {
                  nextNodes.push(link[step.nodeType]);
                  highlight_link(link.id, stroke_opacity);
                });
              });
              remainingNodes = nextNodes;
            }
          });
        }

        function highlight_link(id,opacity){
            d3.select("#link-"+id).style("stroke-opacity", opacity);
        }

      });
    </script>
    <!-- Third graph -->
    <script>


    var w = 900;
    var h = 600;
    var linkDistance=150;

    var colors = d3.scale.category10();

 
    var svg3 = d3.select("#chart3").append("div")
    .classed("svg-container", true)
    .append("svg")
    .attr("preserveAspectRatio", "xMinYMin meet")
    .attr("viewBox", "0 0 900 600")
     //class to make it responsive
    .classed("svg-content-responsive", true);

d3.json("{{ url_for('static', filename='data/for_graph3_v2.json') }}", function(error, dataset) {
  if (error) throw error;

    var force = d3.layout.force()
        .nodes(dataset.nodes)
        .links(dataset.edges)
        .size([w,h])
        .linkDistance([linkDistance])
        .charge([-500])
        .theta(0.1)
        .gravity(0.05)
        .start();

 

    var edges = svg3.selectAll("line")
      .data(dataset.edges)
      .enter()
      .append("line")
      .attr("id",function(d,i) {return 'edge'+i})
      .attr("class", "link")
      .style("stroke","#ccc")
      .style("stroke-opacity","1")
      .attr("stroke-width","1")
      .style("pointer-events", "none");
    
    var nodes = svg3.selectAll("circle")
      .data(dataset.nodes)
      .enter()
      .append("circle")
      .attr({"r":30})
      .style("fill",function(d,i){return colors(i);})
      .call(force.drag)


    var nodelabels = svg3.selectAll(".nodelabel") 
       .data(dataset.nodes)
       .enter()
       .append("text")
       .attr("text-anchor", "middle")
       .attr("dy", ".35em")
       .text(function(d){return d.name;});

    var edgepaths = svg3.selectAll(".edgepath")
        .data(dataset.edges)
        .enter()
        .append('path')
        .attr({'d': function(d) {return 'M '+d.source.x+' '+d.source.y+' L '+ d.target.x +' '+d.target.y},
               'class':'edgepath',
               'fill-opacity':0,
               'stroke-opacity':0,
               'fill':'blue',
               'stroke':'red',
               'id':function(d,i) {return 'edgepath'+i}})
        .style("pointer-events", "none");

    var edgelabels = svg3.selectAll(".edgelabel")
        .data(dataset.edges)
        .enter()
        .append('text')
        .style("pointer-events", "none")
        .attr({'class':'edgelabel',
               'id':function(d,i){return 'edgelabel'+i},
               'dx':50,
               'dy':0,
               'font-size':12,
               'fill':'#aaa'});

    edgelabels.append('textPath')
        .attr('xlink:href',function(d,i) {return '#edgepath'+i})
        .style("pointer-events", "none")
        .text(function(d,i){return d.label});


    svg3.append('defs').append('marker')
        .attr({'id':'arrowhead',
               'viewBox':'-0 -5 10 10',
               'refX':25,
               'refY':0,
               //'markerUnits':'strokeWidth',
               'orient':'auto',
               'markerWidth':10,
               'markerHeight':10,
               'xoverflow':'visible'})
        .append('svg:path')
            .attr('d', 'M 0,-5 L 10 ,0 L 0,5')
            .attr('fill', '#ccc')
            .attr('stroke','#ccc');
     

    force.on("tick", function(){

        edges.attr({"x1": function(d){return d.source.x;},
                    "y1": function(d){return d.source.y;},
                    "x2": function(d){return d.target.x;},
                    "y2": function(d){return d.target.y;}
        });

        nodes.attr({"cx":function(d){return d.x;},
                    "cy":function(d){return d.y;}
        });

        nodelabels.attr("x", function(d) { return d.x; }) 
                  .attr("y", function(d) { return d.y; });

        edgepaths.attr('d', function(d) { var path='M '+d.source.x+' '+d.source.y+' L '+ d.target.x +' '+d.target.y;
                                           //console.log(d)
                                           return path});       

        edgelabels.attr('transform',function(d,i){
            if (d.target.x<d.source.x){
                bbox = this.getBBox();
                rx = bbox.x+bbox.width/2;
                ry = bbox.y+bbox.height/2;
                return 'rotate(180 '+rx+' '+ry+')';
                }
            else {
                return 'rotate(0)';
                }
        });
    });
});

    </script>
    <!-- Table -->
    <script>
        $(document).ready(function() {
            $('#table_id').DataTable( {
                "scrollY":        "100px",
                "scrollCollapse": true,
                "paging":         false,
                "info":           false,
                "searching":      false
                
            } );
        } );
    </script>
  </body>
</html>